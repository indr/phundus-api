!function(a){function b(a){var b="01",c={};for(var d in a){var e=parseInt(b,2);c[a[d]]={bitMask:e,title:a[d]},b=(e<<1).toString(2)}return c}function c(a,b){var c={};for(var d in a){var e,f;if("string"==typeof a[d])if("*"===a[d]){f="";for(e in b)f+="1";c[d]={bitMask:parseInt(f,2)}}else console.log("Access Control Error: Could not parse '"+a[d]+"' as access definition for level '"+d+"'");else{f=0;for(e in a[d])b.hasOwnProperty(a[d][e])?f|=b[a[d][e]].bitMask:console.log("Access Control Error: Could not find role '"+a[d][e]+"' in registered roles while building access for '"+d+"'");c[d]={bitMask:f}}}return c}var d={roles:["public","user","manager","admin"],accessLevels:{"public":"*",anon:["public"],user:["user","manager","admin"],manager:["manager","admin"],admin:["admin"]}};a.userRoles=b(d.roles),a.accessLevels=c(d.accessLevels,a.userRoles)}("undefined"==typeof exports?this.routingConfig={}:exports),angular.module("phundusApp",["ngCookies","ui.router"]).config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(a,b,c,d){var e=window.routingConfig.accessLevels;a.state("public",{"abstract":!0,template:"<ui-view/>",data:{access:e["public"]}}).state("public.shop",{url:"/",template:"<ui-view />",controller:"ShopCtrl"}).state("public.404",{url:"/404",templateUrl:"views/404.html"}).state("public.debug",{url:"/debug",templateUrl:"views/debug.html",controller:"DebugCtrl"}),a.state("anon",{"abstract":!0,template:"<ui-view/>",data:{access:e.anon}}).state("anon.login",{url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("anon.register",{url:"/register",templateUrl:"views/register.html",controller:"RegisterCtrl"}).state("anon.logout",{url:"/goodbye",templateUrl:"views/logout.html"}),a.state("admin",{"abstract":!0,template:"<ui-view/>",data:{access:e.admin}}).state("admin.admin",{url:"/admin",templateUrl:"views/admin.html",controller:"AdminCtrl"}),b.otherwise("/404"),c.html5Mode(!1),b.rule(function(a,b){return"file"!==b.protocol()&&""===b.path()?"/":void 0}),d.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return(401===c.status||403===c.status)&&(b.search("returnPath",encodeURI(b.path())),b.path("/login")),a.reject(c)}}}])}]),angular.module("phundusApp").controller("AdminCtrl",["$rootScope","$scope","Users","Auth",function(a,b,c,d){b.loading=!0,b.userRoles=d.userRoles,c.getAll(function(a){b.users=a,b.loading=!1},function(){a.error="Failed to fetch users.",b.loading=!1})}]),angular.module("phundusApp").controller("DebugCtrl",["$scope","$http","$cookies",function(a,b,c){a.status={},b.get("/api/v1/status").success(function(b){a.status=b}),a.cookies=c.getAll()}]),angular.module("phundusApp").controller("LoginCtrl",["$rootScope","$scope","$location","$window","Auth",function(a,b,c,d,e){a.error="",a.warn="",b.rememberMe=!0,b.login=function(){e.login({username:b.username,password:b.password,rememberme:b.rememberMe},function(){var a=c.search().ReturnUrl;if(a)d.location.href=a;else{var b=c.search().returnPath||"/debug";delete c.search().returnPath,c.path(b)}},function(){a.error="Failed to login."})}}]),angular.module("phundusApp").controller("NavCtrl",["$rootScope","$scope","$location","Auth",function(a,b,c,d){b.user=d.user,b.userRoles=d.userRoles,b.accessLevels=d.accessLevels,b.logout=function(){d.logout(function(){c.path("/goodbye")},function(b){a.error=b})}}]),angular.module("phundusApp").controller("RegisterCtrl",[function(){}]),angular.module("phundusApp").controller("ShopCtrl",["$timeout","$window",function(a,b){a(function(){b.location.href="shop"},0)}]),angular.module("phundusApp").directive("accessLevel",["Auth",function(a){return{restrict:"A",link:function(b,c,d){function e(){f&&g&&(a.authorize(g,f)?c.css("display",h):c.css("display","none"))}var f,g,h=c.css("display");b.user=a.user,b.$watch("user",function(a){a.role&&(f=a.role),e()},!0),d.$observe("accessLevel",function(a){a&&(g=b.$eval(a)),e()})}}}]),angular.module("phundusApp").directive("activeNav",["$location",function(a){function b(a){return"/"!==a[a.length-1]&&(a+="/"),a}return{restrict:"A",link:function(c,d,e){var f=d[0];"A"!==d[0].tagName.toUpperCase()&&(f=d.find("a")[0]);var g=f.href;c.location=a,c.$watch("location.absUrl()",function(a){g=b(g),a=b(a),g===a||"nestedTop"===e.activeNav&&0===a.indexOf(g)?d.addClass("active"):d.removeClass("active")})}}}]),angular.module("phundusApp").factory("Auth",["$http","$cookies",function(a,b){function c(a){console.log("Change user: ",a),angular.extend(f,a)}var d=window.routingConfig.accessLevels,e=window.routingConfig.userRoles,f=b.getObject("ph.user")||{username:"",role:e["public"]};return console.log("Current user: ",f),{authorize:function(a,b){return void 0===b&&(b=f.role),a.bitMask&b.bitMask},isLoggedIn:function(a){return void 0===a&&(a=f),a.role.title===e.user.title||a.role.title===e.admin.title},register:function(b,d,e){a.post("/api/v1/register",b).success(function(a){c(a),d()}).error(e)},login:function(b,d,e){a.post("/api/v1/login",b).success(function(f){a.post("/account/logon",{email:b.username,password:b.password,rememberme:b.rememberme}).success(function(){c(f),d(f)}).error(e)}).error(e)},logout:function(b,d){a.post("/api/v1/logout").success(function(){a.post("/account/logoff").success(function(){c({username:"",role:e["public"]}),b()}).error(d)}).error(d)},accessLevels:d,userRoles:e,user:f}}]),angular.module("phundusApp").factory("Users",["$http",function(a){return{getAll:function(b,c){a.get("/api/v1/users").success(b).error(c)}}}]),angular.module("phundusApp").run(["$templateCache",function(a){"use strict";a.put("views/404.html","<h1>404</h1> <p>Hier ist nichts zu finden.</p> <div ui-view></div>"),a.put("views/admin.html",'<h1>admin</h1> <p>This view is visible to users with the administrator role.</p> <table class="table table-striped" data-ng-hide="loading"> <thead> <tr> <th>#</th> <th>Username</th> <th>Role</th> </tr> </thead> <tbody> <tr data-ng-repeat="user in users"> <td>{{user.id}}</td> <td>{{user.username}}</td> <td> <span class="label" data-ng-class="{&quot;label-info&quot;: user.role.title == userRoles.user.title, &quot;label-success&quot;: user.role.title == userRoles.admin.title}"> {{user.role.title}} </span> </td> </tr> </tbody> </table>'),a.put("views/debug.html","<h1>Debug</h1> <h2>Status</h2> <pre>{{status|json}}</pre> <h2>Cookies</h2> <pre>{{cookies|json}}</pre>"),a.put("views/login.html",'<h1>Anmelden</h1> <form class="form-horizontal" ng-submit="login()" name="loginForm"> <div class="form-group"> <label class="control-label col-sm-3" for="username">E-Mail-Adresse</label> <div class="col-sm-9"> <input class="form-control" type="text" data-ng-model="username" placeholder="E-Mail-Adresse" id="username" required autofocus> </div> </div> <div class="form-group"> <label class="control-label col-sm-3" for="password">Passwort</label> <div class="col-sm-9"> <input class="form-control" type="password" data-ng-model="password" placeholder="Passwort" id="password" required> </div> </div> <div class="form-group"> <div class="checkbox col-sm-offset-3 col-sm-9"> <label> <input type="checkbox" data-ng-model="rememberMe"> Angemeldet bleiben </label> </div> </div> <div class="form-group"> <div class="col-sm-offset-3 col-sm-9"> <button class="btn btn-default" type="submit" data-ng-disabled="loginForm.$invalid">Anmelden</button> </div> </div> </form>'),a.put("views/logout.html","<h1>logout</h1> <p>Auf ein andermal...</p>"),a.put("views/main.html",'<!--<div class="jumbotron">\n  <h1>\'Allo, \'Allo!</h1>\n  <p class="lead">&nbsp;\n    <img src="images/yeoman.8cb970fb.png" alt="I\'m Yeoman"><br>\n    Always a pleasure scaffolding your apps.\n  </p>\n  <p><a class="btn btn-lg btn-success" ng-href="shop">zum Shop</a></p>\n</div>--><!--<div class="row marketing">\n  <h4>HTML5 Boilerplate</h4>\n  <p>\n    HTML5 Boilerplate is a professional front-end template for building fast, robust, and adaptable web apps or sites.\n  </p>\n\n  <h4>Angular</h4>\n  <p>\n    AngularJS is a toolset for building the framework most suited to your application development.\n  </p>\n\n  <h4>Karma</h4>\n  <p>Spectacular Test Runner for JavaScript.</p>\n</div>--> <h1>public</h1> <p>main.html</p> <div ui-view></div>'),a.put("views/register.html","<h1>register</h1> <p>This is the register view.</p> <div ui-view></div>")}]);