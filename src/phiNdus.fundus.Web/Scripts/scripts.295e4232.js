!function(a){function b(a){var b="01",c={};for(var d in a){var e=parseInt(b,2);c[a[d]]={bitMask:e,title:a[d]},b=(e<<1).toString(2)}return c}function c(a,b){var c={};for(var d in a){var e,f;if("string"==typeof a[d])if("*"===a[d]){f="";for(e in b)f+="1";c[d]={bitMask:parseInt(f,2)}}else console.log("Access Control Error: Could not parse '"+a[d]+"' as access definition for level '"+d+"'");else{f=0;for(e in a[d])b.hasOwnProperty(a[d][e])?f|=b[a[d][e]].bitMask:console.log("Access Control Error: Could not find role '"+a[d][e]+"' in registered roles while building access for '"+d+"'");c[d]={bitMask:f}}}return c}var d={roles:["public","user","manager","admin"],accessLevels:{"public":"*",anon:["public"],user:["user","manager","admin"],manager:["manager","admin"],admin:["admin"]}};a.userRoles=b(d.roles),a.accessLevels=c(d.accessLevels,a.userRoles)}("undefined"==typeof exports?this.routingConfig={}:exports);var app=angular.module("phundusApp",["leaflet-directive","ngCookies","ui.gravatar","ui.router","uuid","xeditable"]).constant("_",window._).config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(a,b,c,d){var e=window.routingConfig.accessLevels;a.state("public",{"abstract":!0,template:"<ui-view/>",data:{access:e["public"]}}).state("public.shop",{url:"/",template:"<ui-view />",controller:"ShopCtrl"}).state("public.404",{url:"/404",templateUrl:"views/404.html"}).state("public.debug",{url:"/debug",templateUrl:"views/debug.html",controller:"DebugCtrl"}),a.state("anon",{"abstract":!0,template:"<ui-view/>",data:{access:e.anon}}).state("anon.login",{url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("anon.register",{url:"/register",templateUrl:"views/register.html",controller:"RegisterCtrl"}).state("anon.logout",{url:"/goodbye",templateUrl:"views/logout.html"}),a.state("users",{"abstract":!0,url:"/users/:userId",templateUrl:"views/users.html",data:{access:e.user},controller:"UsersCtrl"}).state("users.home",{url:"",templateUrl:"views/users/home.html",controller:"UsersHomeCtrl"}).state("users.articles",{url:"/articles",templateUrl:"views/users/articles.html",controller:"UsersArticlesCtrl"}).state("users.orders",{url:"/orders",templateUrl:"views/users/orders.html",controller:"UsersOrdersCtrl"}),a.state("admin",{"abstract":!0,template:"<ui-view/>",data:{access:e.admin}}).state("admin.admin",{url:"/admin",templateUrl:"views/admin.html",controller:"AdminCtrl"}),b.otherwise("/404"),c.html5Mode(!1),b.rule(function(a,b){return"file"!==b.protocol()&&""===b.path()?"/":void 0}),d.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return(401===c.status||403===c.status)&&(b.search("returnPath",encodeURI(b.path())),b.path("/login")),a.reject(c)}}}])}]);angular.module("phundusApp").filter("orderStatusText",function(){return function(a){return{Pending:"Provisorisch",Approved:"Bestätigt",Rejected:"Abgelehnt",Closed:"Abgeschlossen"}[a]}}),app.run(["editableOptions",function(a){a.theme="bs3"}]),angular.module("phundusApp").controller("AdminCtrl",["$scope","Users","Auth","Alert",function(a,b,c,d){a.loading=!0,a.userRoles=c.userRoles,b.getAll(function(b){a.users=b,a.loading=!1},function(){d.error("Failed to fetch users."),a.loading=!1})}]),angular.module("phundusApp").controller("DebugCtrl",["$scope","$http","$cookies","Alert",function(a,b,c,d){a.status={},b.get("/api/v1/status").success(function(b){a.status=b}),a.cookies=c.getAll(),a.alertMsg="Alert message",a.addError=function(){d.error(a.alertMsg)},a.addDanger=function(){d.danger(a.alertMsg)},a.addWarning=function(){d.warning(a.alertMsg)},a.addSuccess=function(){d.success(a.alertMsg)}}]),angular.module("phundusApp").controller("LoginCtrl",["$scope","$location","$window","Auth","Alert",function(a,b,c,d,e){a.rememberMe=!0,a.login=function(){d.login({username:a.username,password:a.password,rememberme:a.rememberMe},function(a){var d=b.search().ReturnUrl;if(d)c.location.href=d;else{var e=b.search().returnPath||"/users/"+a.userId;delete b.search().returnPath,b.path(e)}},function(){e.error("Failed to login.")})}}]),angular.module("phundusApp").controller("NavCtrl",["$rootScope","$scope","$location","$window","$timeout","Auth","Alert",function(a,b,c,d,e,f,g){a.alerts=g.alerts,a.dismissAlert=function(a,b){g.dismiss(a,b)},b.user=f.user,b.userRoles=f.userRoles,b.accessLevels=f.accessLevels,b.queryString="",b.search=function(){d.location.href="/shop/Search?queryString="+b.queryString},b.logout=function(){f.logout(function(){c.path("/goodbye")},function(a){g.error(a)})}}]),angular.module("phundusApp").controller("RegisterCtrl",[function(){}]),angular.module("phundusApp").controller("ShopCtrl",["$timeout","$window",function(a,b){a(function(){b.location.href="shop"},0)}]),angular.module("phundusApp").controller("UsersCtrl",["$scope","$stateParams","Auth",function(a,b,c){a.userId=b.userId,a.isHome=a.userId+""==c.user.userId+""}]),angular.module("phundusApp").controller("UsersHomeCtrl",["$scope","$stateParams","Users","Stores","Auth","Alert",function(a,b,c,d,e,f){a.loaded=!1,a.isHome=!1,a.user=null,a.store=null,c.get(b.userId,function(b){a.user=b,a.store=a.user.store,a.isHome=a.user.userId===e.user.userId,a.loaded=!0},function(a){f.error("Failed to fetch user: "+a)}),a.openStore=function(){d.post(a.user.userId,function(b){a.store=b,f.success("Successfully opened your store!")},function(a){f.error("Failed to open your store: "+a)})}}]),angular.module("phundusApp").controller("UsersOrdersCtrl",["$rootScope","$scope","Orders",function(a,b,c){b.search={status:""},b.order="-createdUtc",b.orderBy=function(a){b.order===a?b.order="-"+a:b.order=a},c.getAll(function(a){b.orders=a},function(b){a.error(b)})}]),angular.module("phundusApp").controller("UsersContractsCtrl",["$rootScope","$scope",function(a,b){b.search={status:""},b.order="-createdUtc",b.orderBy=function(a){b.order===a?b.order="-"+a:b.order=a}}]),angular.module("phundusApp").directive("phUserVcard",[function(){return{restrict:"E",replace:"true",scope:{user:"=",isEditable:"="},templateUrl:"views/directives/ph-user-vcard.html"}}]),angular.module("phundusApp").directive("phUserStore",["$timeout","Stores","Alert","leafletData","leafletMarkersHelpers",function(a,b,c,d,e){return{restrict:"E",replace:"true",scope:{store:"=",isEditable:"="},link:function(f){var g={lat:46.80121,lng:8.226692};console.log(d),a(function(){d.getMap().then(function(a){a.setView(g,7)})},0);var h=function(){f.store&&f.store.coordinate&&a(function(){d.getMap().then(function(a){var b={lat:f.store.coordinate.latitude,lng:f.store.coordinate.longitude};a.setView(b,16),f.marker?f.marker.setLatLng(b):(f.marker=e.createMarker(b,{draggable:!0}),f.marker.addTo(a))})},500)};h(),f.fromMap=function(){d.getMap().then(function(a){var b=a.getCenter();f.userStoreCoordinateForm.latitude.$setViewValue(b.lat),f.userStoreCoordinateForm.latitude.$render(),f.userStoreCoordinateForm.longitude.$setViewValue(b.lng),f.userStoreCoordinateForm.longitude.$render()})},f.$watch("store.coordinate.latitude",function(){h()}),f.$watch("store.coordinate.longitude",function(){h()}),f.updateAddress=function(a){b.putAddress(f.store.storeId,a.address,function(){},function(a){c.danger(a)})},f.updateOpeningHours=function(a){b.putOpeningHours(f.store.storeId,a.openingHours,function(){},function(a){c.danger(a)})},f.updateCoordinate=function(a){b.putCoordinate(f.store.storeId,a,function(){},function(a){c.danger(a)})}},templateUrl:"views/directives/ph-user-store.html"}}]),angular.module("phundusApp").factory("Alert",["$timeout","uuid4",function(a,b){var c={},d=function(a,b){delete c[a][b]},e=function(e,f){var g=b.generate();c[e]=c[e]||{},c[e][g]=f,a(d,4e3,!0,e,g)};return{alerts:c,dismiss:function(a,b){d(a,b)},danger:function(a){e("danger",a)},error:function(a){e("danger",a)},info:function(a){e("info",a)},success:function(a){e("success",a)},warning:function(a){e("warning",a)}}}]),angular.module("phundusApp").factory("Auth",["$http","$cookies","_",function(a,b,c){function d(a){angular.extend(i,a),j=c.find(a.memberships,{selected:!0}),f()}function e(a){c.forEach(i.memberships,function(b){b.selected=b===a}),j=a,f()}function f(){if(j){var a=h.manager.bitMask;j.isManager?i.role.bitMask=i.role.bitMask|a:i.role.bitMask=i.role.bitMask&~a}}var g=window.routingConfig.accessLevels,h=window.routingConfig.userRoles,i=b.getObject("ph.user")||{username:"",role:h["public"]},j=c.find(i.memberships,{selected:!0});return f(),{authorize:function(a,b){return void 0===b&&(b=i.role),a.bitMask&b.bitMask},isLoggedIn:function(a){return void 0===a&&(a=i),a.role.title===h.user.title||a.role.title===h.admin.title},register:function(b,c,e){a.post("/api/v1/register",b).success(function(a){d(a),c()}).error(e)},login:function(b,c,e){a.post("/api/v1/login",b).success(function(f){a.post("/account/logon",{email:b.username,password:b.password,rememberme:b.rememberme}).success(function(){d(f),c(f)}).error(e)}).error(e)},logout:function(b,c){a.post("/api/v1/logout").success(function(){a.post("/account/logoff").success(function(){d({memberships:void 0,username:"",role:h["public"]}),b()}).error(c)}).error(c)},select:function(b,c,d){e(b),a.get("/organization/select/"+b.organizationId).success(function(a){c&&c(a)}).error(d)},accessLevels:g,userRoles:h,user:i}}]),angular.module("phundusApp").factory("Contracts",["$http",function(a){return{getAll:function(b,c){a.get("/api/contracts").success(b).error(c)}}}]).factory("Orders",["$http",function(a){return{getAll:function(b,c){a.get("/api/orders").success(b).error(c)}}}]).factory("Stores",["$http",function(a){return{get:function(b,c,d){a.get("/api/v1/stores/"+b).success(c).error(d)},post:function(b,c,d){a.post("/api/v1/stores",{userId:b}).success(c).error(d)},putAddress:function(b,c,d,e){a.put("/api/v1/stores/"+b+"/address",{address:c}).success(d).error(e)},putOpeningHours:function(b,c,d,e){a.put("/api/v1/stores/"+b+"/opening-hours",{openingHours:c}).success(d).error(e)},putCoordinate:function(b,c,d,e){a.put("/api/v1/stores/"+b+"/coordinate",{coordinate:{latitude:parseFloat(c.latitude),longitude:parseFloat(c.longitude)}}).success(d).error(e)}}}]).factory("Users",["$http",function(a){return{getAll:function(b,c){a.get("/api/v1/users").success(b).error(c)},get:function(b,c,d){a.get("/api/v1/users/"+b).success(c).error(d)}}}]),angular.module("phundusApp").directive("accessLevel",["Auth",function(a){return{restrict:"A",link:function(b,c,d){function e(){f&&g&&(a.authorize(g,f)?c.css("display",h):c.css("display","none"))}var f,g,h=c.css("display");b.user=a.user,b.$watch("user",function(a){a.role&&(f=a.role),e()},!0),d.$observe("accessLevel",function(a){a&&(g=b.$eval(a)),e()})}}}]),angular.module("phundusApp").directive("activeNav",["$location",function(a){function b(a){return"/"!==a[a.length-1]&&(a+="/"),a}return{restrict:"A",link:function(c,d,e){var f=d[0];"A"!==d[0].tagName.toUpperCase()&&(f=d.find("a")[0]);var g=f.href;c.location=a,c.$watch("location.absUrl()",function(a){g=b(g),a=b(a),g===a||"nestedTop"===e.activeNav&&0===a.indexOf(g)?d.addClass("active"):d.removeClass("active")})}}}]),angular.module("phundusApp").run(["$templateCache",function(a){"use strict";a.put("views/404.html","<h1>404</h1> <p>Hier ist nichts zu finden.</p> <div ui-view></div>"),a.put("views/admin.html",'<h1>admin</h1> <p>This view is visible to users with the administrator role.</p> <table class="table table-striped" data-ng-hide="loading"> <thead> <tr> <th>#</th> <th>Username</th> <th>Role</th> </tr> </thead> <tbody> <tr data-ng-repeat="user in users"> <td>{{user.id}}</td> <td>{{user.username}}</td> <td> <span class="label" data-ng-class="{&quot;label-info&quot;: user.role.title == userRoles.user.title, &quot;label-success&quot;: user.role.title == userRoles.admin.title}"> {{user.role.title}} </span> </td> </tr> </tbody> </table>'),a.put("views/debug.html",'<h1>Debug</h1> <h2>Test Alerts</h2> <form> <div class="form-group"> <input type="text" class="form-control" id="inputAlertMsg" data-ng-model="alertMsg"> </div> <button class="btn btn-default" data-ng-click="addError()">Add error</button> <button class="btn btn-default" data-ng-click="addDanger()">Add danger</button> <button class="btn btn-default" data-ng-click="addWarning()">Add warning</button> <button class="btn btn-default" data-ng-click="addSuccess()">Add success</button> </form> <h2>Status</h2> <pre>{{status|json}}</pre> <h2>Cookies</h2> <pre>{{cookies|json}}</pre>'),a.put("views/directives/ph-user-store.html",'<div data-ng-show="store" class="store"> <h2>Materialstelle</h2> <div class="row"> <div class="col-sm-3"> <label>Adresse</label> </div> <div class="col-sm-9"> <p data-ng-hide="isEditable" style="white-space:pre">{{store.address}}</p> <form data-editable-form name="userStoreAddressForm" data-ng-show="isEditable" data-onbeforesave="updateAddress($data)"> <div class="form-group"> <button type="button" class="btn btn-default pull-right" data-ng-click="userStoreAddressForm.$show()" data-ng-show="!userStoreAddressForm.$visible" title="Bearbeiten"> <span class="glyphicon glyphicon-edit"></span> </button> <p> <span style="white-space:pre" data-editable-textarea="store.address" data-e-rows="5" data-e-name="address">{{store.address}}</span> </p> </div> <div class="form-group" data-ng-show="userStoreAddressForm.$visible"> <button type="submit" class="btn btn-primary" data-ng-disabled="userStoreAddressForm.$waiting"> Speichern </button> <button type="button" class="btn btn-default" data-ng-disabled="userStoreAddressForm.$waiting" data-ng-click="userStoreAddressForm.$cancel()"> Verwerfen </button> </div> </form> </div> </div> <div class="row"> <div class="col-sm-3"> <label>Öffnungszeiten</label> </div> <div class="col-sm-9"> <p data-ng-hide="isEditable" style="white-space:pre">{{store.openingHours}}</p> <form data-editable-form name="userStoreOpeningHoursForm" data-ng-show="isEditable" data-onbeforesave="updateOpeningHours($data)"> <div class="form-group"> <button type="button" class="btn btn-default pull-right" data-ng-click="userStoreOpeningHoursForm.$show()" data-ng-show="!userStoreOpeningHoursForm.$visible" title="Bearbeiten"> <span class="glyphicon glyphicon-edit"></span> </button> <p> <span style="white-space:pre" data-editable-textarea="store.openingHours" data-e-rows="5" data-e-name="openingHours">{{store.openingHours}}</span> </p> </div> <div class="form-group" data-ng-show="userStoreOpeningHoursForm.$visible"> <button type="submit" class="btn btn-primary" data-ng-disabled="userStoreOpeningHoursForm.$waiting"> Speichern </button> <button type="button" class="btn btn-default" data-ng-disabled="userStoreOpeningHoursForm.$waiting" data-ng-click="userStoreOpeningHoursForm.$cancel()"> Verwerfen </button> </div> </form> </div> </div> <div class="row" data-ng-show="isEditable"> <div class="col-sm-3"> <label>Koordinaten</label> <p data-ng-show="userStoreCoordinateForm.$visible">Latitude / Longitude</p> </div> <div class="col-sm-9"> <p data-ng-hide="isEditable">{{store.coordinate.latitude}}</p> <p data-ng-hide="isEditable">{{store.coordinate.longitude}}</p> <button type="button" class="btn btn-default pull-right" data-ng-click="userStoreCoordinateForm.$show()" data-ng-show="!userStoreCoordinateForm.$visible" title="Bearbeiten"> <span class="glyphicon glyphicon-edit"></span> </button> <form data-editable-form name="userStoreCoordinateForm" data-ng-show="isEditable" data-onbeforesave="updateCoordinate($data)"> <div class="form-group"> <p><span data-editable-text="store.coordinate.latitude" data-e-name="latitude">{{store.coordinate.latitude}}</span></p> <p><span data-editable-text="store.coordinate.longitude" data-e-name="longitude">{{store.coordinate.longitude}}</span></p> </div> <div class="form-group" data-ng-show="userStoreCoordinateForm.$visible"> <button type="button" class="btn btn-default" data-ng-disabled="userStoreCoorindateForm.$waiting" data-ng-click="fromMap()" title="Koordinate von der Karte übertragen"><span class="glyphicon glyphicon-arrow-up"></span></button> <button type="submit" class="btn btn-primary" data-ng-disabled="userStoreCoordinateForm.$waiting"> Speichern </button> <button type="button" class="btn btn-default" data-ng-disabled="userStoreCoordinateForm.$waiting" data-ng-click="userStoreCoordinateForm.$cancel()"> Verwerfen </button> </div> </form> </div> </div> <div class="row"> <div class="col-sm-12"> <leaflet width="100%" height="400px" style="margin-bottom:10px"></leaflet> </div> </div> </div>'),a.put("views/directives/ph-user-vcard.html",'<div class="vcard"> <a class="vcard-avatar"> <img class="avatar" gravatar-src-once="user.email" gravatar-size="212"> </a> <h1 class="vcard-names"> <span class="vcard-fullname">{{user.fullName}}</span> <!--<span class="vcard-username">{{user.username}}</span>--> </h1> <!--\n  <ul class="vcard-details list-unstyled">\n    <li><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> <a href="mailto:{{user.email}}">{{user.email}}</a>\n    </li>\n  </ul>\n  --> <div class="vcard-memberships" data-ng-show="user.memberships.length"> <div class="panel panel-default"> <div class="panel-heading">Organisationen</div> <table class="table"> <tr data-ng-repeat="membership in user.memberships"> <td><a href="/{{membership.organizationFriendlyPath}}"> {{membership.organizationName}}</a> </td> </tr> </table> </div> </div> </div>'),a.put("views/login.html",'<h1>Anmelden</h1> <form class="form-horizontal" ng-submit="login()" name="loginForm"> <div class="form-group"> <label class="control-label col-sm-3" for="username">E-Mail-Adresse</label> <div class="col-sm-9"> <input class="form-control" type="text" data-ng-model="username" placeholder="E-Mail-Adresse" id="username" required autofocus> </div> </div> <div class="form-group"> <label class="control-label col-sm-3" for="password">Passwort</label> <div class="col-sm-9"> <input class="form-control" type="password" data-ng-model="password" placeholder="Passwort" id="password" required> </div> </div> <!--\n  <div class="form-group">\n    <div class="checkbox col-sm-offset-3 col-sm-9">\n      <label>\n        <input type="checkbox" data-ng-model="rememberMe" /> Angemeldet bleiben\n      </label>\n    </div>\n  </div>\n  --> <div class="form-group"> <div class="col-sm-offset-3 col-sm-9"> <button class="btn btn-default" type="submit" data-ng-disabled="loginForm.$invalid">Anmelden</button> </div> </div> </form>'),a.put("views/logout.html","<h1>logout</h1> <p>Auf ein andermal...</p>"),a.put("views/main.html",'<!--<div class="jumbotron">\n  <h1>\'Allo, \'Allo!</h1>\n  <p class="lead">&nbsp;\n    <img src="images/yeoman.8cb970fb.png" alt="I\'m Yeoman"><br>\n    Always a pleasure scaffolding your apps.\n  </p>\n  <p><a class="btn btn-lg btn-success" ng-href="shop">zum Shop</a></p>\n</div>--><!--<div class="row marketing">\n  <h4>HTML5 Boilerplate</h4>\n  <p>\n    HTML5 Boilerplate is a professional front-end template for building fast, robust, and adaptable web apps or sites.\n  </p>\n\n  <h4>Angular</h4>\n  <p>\n    AngularJS is a toolset for building the framework most suited to your application development.\n  </p>\n\n  <h4>Karma</h4>\n  <p>Spectacular Test Runner for JavaScript.</p>\n</div>--> <h1>public</h1> <p>main.html</p> <div ui-view></div>'),a.put("views/register.html","<h1>register</h1> <p>This is the register view.</p> <div ui-view></div>"),a.put("views/users.html",'<ul class="nav nav-tabs" style="margin-bottom:10px" data-ng-show="isHome"> <li ui-sref-active="active" role="presentation"><a href="" ui-sref="users.home({userId: userId})"><span class="glyphicon glyphicon-user"></span> </a></li> <li ui-sref-active="active" role="presentation"><a href="" ui-sref="users.articles({userId: userId})">Material</a></li> <li ui-sref-active="active" role="presentation"><a href="" ui-sref="users.orders({userId: userId})">Bestellungen</a></li> <!--<li ui-sref-active="active" role="presentation"><a href="" ui-sref="users.contracts({userId: userId})">Verträge</a></li>--> </ul> <ui-view>'),a.put("views/users/articles.html",'<p>views/user/articles.html</p> <div class="alert alert-info" role="alert"> <p><strong>Notiz</strong></p> <p>Hier kann der Benutzer sein eigenes Material verwalten.</p> </div>'),a.put("views/users/contracts.html",'<div class="alert alert-info" role="alert"> <p><strong>Notiz</strong></p> <p>Dieses Feature ist noch nicht implementiert.</p> </div>'),a.put("views/users/home.html",'<div class="row" data-ng-show="loaded"> <ph-user-vcard class="col-sm-4" data-user="user"></ph-user-vcard> <div class="col-sm-8" data-ng-hide="store"> <div class="jumbotron" data-ng-show="isHome"> <button class="btn btn-default" data-ng-click="openStore()">Eigene Materialstelle eröffnen</button> </div> <div class="jumbotron" data-ng-hide="isHome"> <p>Dieser Benutzer hat keine eigene Materialstelle eröffnet.</p> </div> </div> <ph-user-store class="col-sm-8" data-store="store" data-map="map" data-is-editable="isHome"></ph-user-store> </div>'),a.put("views/users/orders.html",'<table class="table"> <thead> <tr> <th><a href="" data-ng-click="orderBy(\'orderId\')">Nummer</a></th> <th><a href="" data-ng-click="orderBy(\'organizationName\')">Organisation</a></th> <th><a href="" data-ng-click="orderBy(\'createdUtc\')">Erstellt</a></th> <th><a href="" data-ng-click="orderBy(\'status\')">Status</a></th> <th><a href="" data-ng-click="orderBy(\'modifiedUtc\')">Bearbeitet</a></th> <th></th> </tr> </thead> <tbody> <tr data-ng-repeat="order in filtered = (orders | filter:search) | orderBy:order"> <td>{{order.orderId}}</td> <td>{{order.organizationName}}</td> <td> <ph-date value="order.createdUtc"></ph-date> </td> <td>{{order.status | orderStatusText}}</td> <td> <ph-date value="order.modifiedUtc"></ph-date> </td> <td class="text-right"> <!--\n      <a class="btn btn-default btn-small" data-ng-click="openOrder(order)">Öffnen</a>\n      --> <a class="btn btn-default btn-small" href="/api/orders/{{order.orderId}}.pdf">PDF</a> </td> </tr> </tbody> </table>')}]);